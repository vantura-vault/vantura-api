generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String
  // password  String
  companyId String?   // User's company (optional - user might not have company yet)
  role      String    @default("member") // "owner", "admin", "member"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  authTokens AuthToken[]
  company    Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([companyId])
  @@map("users")
}

model AuthToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("auth_tokens")
}

// ============================================
// COMPANY
// ============================================

model Company {
  id                String   @id @default(cuid())
  name              String
  industry          String?
  description       String?  @db.Text
  values            String?  @db.Text // JSON array of core values
  brandVoice        String?  @db.Text
  targetAudience    String?  @db.Text
  strategicGoals    String?  @db.Text // JSON array of goals with current/target metrics
  contentPriorities String?  @db.Text // JSON object: content style preferences (data-driven, storytelling, educational, etc.)
  profilePictureUrl String?  // Company profile picture/logo URL
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  users             User[]
  platforms         CompanyPlatform[]
  posts             Post[]
  relationships     CompanyRelationship[] @relation("CompanyA")
  relatedTo         CompanyRelationship[] @relation("CompanyB")
  platformSnapshots PlatformSnapshot[]
  blueprints        Blueprint[]

  @@map("companies")
}

model CompanyRelationship {
  id               String   @id @default(cuid())
  companyAId       String
  companyBId       String
  relationshipType String   // "competitor", "partner", etc.
  createdAt        DateTime @default(now())

  // Relations
  companyA Company @relation("CompanyA", fields: [companyAId], references: [id], onDelete: Cascade)
  companyB Company @relation("CompanyB", fields: [companyBId], references: [id], onDelete: Cascade)

  @@unique([companyAId, companyBId])
  @@index([companyAId])
  @@index([companyBId])
  @@map("company_relationships")
}

// ============================================
// PLATFORMS
// ============================================

model Platform {
  id   String @id @default(cuid())
  name String @unique

  // Relations
  companyPlatforms CompanyPlatform[]
  posts            Post[]

  @@map("platforms")
}

model CompanyPlatform {
  id         String   @id @default(cuid())
  companyId  String
  platformId String
  profileUrl String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform  Platform           @relation(fields: [platformId], references: [id], onDelete: Cascade)
  snapshots PlatformSnapshot[]

  @@unique([companyId, platformId])
  @@index([companyId])
  @@index([platformId])
  @@map("company_platforms")
}

model PlatformSnapshot {
  id            String   @id @default(cuid())
  companyId     String
  platformId    String
  capturedAt    DateTime @default(now())
  followerCount Int
  postCount     Int

  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyPlatform CompanyPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([companyId, platformId, capturedAt])
  @@map("platform_snapshots")
}

// ============================================
// POSTS & METRICS
// ============================================

model Post {
  id             String   @id @default(cuid())
  companyId      String
  platformId     String
  platformPostId String   // External ID from the platform
  captionText    String?  @db.Text
  postUrl        String
  mediaType      String   // "image", "video", "carousel", "reel"
  postedAt       DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform         Platform       @relation(fields: [platformId], references: [id], onDelete: Cascade)
  metricsSnapshots PostSnapshot[]
  analysis         PostAnalysis?

  @@unique([platformId, platformPostId])
  @@index([companyId])
  @@index([platformId])
  @@index([postedAt])
  @@map("posts")
}

model PostSnapshot {
  id           String   @id @default(cuid())
  postId       String
  capturedAt   DateTime @default(now())
  likeCount    Int      @default(0)
  commentCount Int      @default(0)

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, capturedAt])
  @@map("post_snapshots")
}

// ============================================
// AI ANALYSIS
// ============================================

model PostAnalysis {
  id                     String   @id @default(cuid())
  postId                 String   @unique
  modelVersion           String   // Track which AI model version was used
  runAt                  DateTime @default(now())

  // Performance metrics
  impressions            Int      @default(0) // Total views/impressions
  engagement             Int      @default(0) // Total engagement (likes + comments + shares)

  // Analysis results
  topics                 String[] // Array of identified topics
  summary                String   @db.Text
  entities               String[] // Brands, people, places mentioned
  captionSentiment       Float    // -1.0 to 1.0
  avgCommentSentiment    Float?
  commentSentimentStd    Float?   // Standard deviation
  medianCommentSentiment Float?
  positiveDescription    String   @db.Text
  imageDescription       String   @db.Text
  negativeDescription    String   @db.Text

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([runAt])
  @@map("post_analyses")
}

// ============================================
// BLUEPRINTS - AI-Generated Post Strategies
// ============================================

model Blueprint {
  id        String   @id @default(cuid())
  companyId String
  title     String   // e.g., "Engaging LinkedIn Thought Leadership Post"
  platform  String   // "LinkedIn", "Twitter", etc.

  // Generation inputs
  objective           String   // User's objective (e.g., "thought leadership")
  topicTags           String[] // Topics used for generation
  contentAngle        String?  // Content focus: "data-driven", "storytelling", "educational", "how-to"
  useDataChamber      Boolean  @default(true)
  useYourTopPosts     Boolean  @default(true)
  useCompetitorPosts  Boolean  @default(true)

  // AI Reasoning
  reasoning           String?  @db.Text // LLM's explanation for why this blueprint works

  // Visual Description
  visualDescription String   @db.Text

  // References
  references        String?  @db.Text // JSON: inspired by top 3 industry leaders with avatars

  // Post Copy
  hook              String   @db.Text
  context           String   @db.Text

  // Hashtags & Mentions
  hashtags          Json     // Array of {tag: string, engagement: string}
  mentions          Json?    // Array of {handle: string, engagement: string}

  // Posting Intelligence
  bestTimeToPost        String?  // e.g., "Tuesdays, 10 AM PST"
  recommendedFormat     String?  // e.g., "Carousel Post (Image + Text)"
  postingInsight        String?  @db.Text

  // Data & Insights
  dataSources           String[] // e.g., ["Competitor Vault", "Talkwater API", "Brandwat"]
  timeWindow            String?  // e.g., "Last 30 Days"
  confidence            Float?   // e.g., 0.90 for 90%
  yourPerformanceScore  Float?   // Performance bar value (0-100)
  competitorScore       Float?   // Competitor performance bar value (0-100)

  // Performance Forecast
  vanturaScore          Float?   // e.g., 85 (out of 100)
  estimatedReachMin     Int?     // e.g., 8500
  estimatedReachMax     Int?     // e.g., 10000
  estimatedEngagementMin Float?  // e.g., 1.2 (percentage)
  estimatedEngagementMax Float?  // e.g., 1.8 (percentage)
  optimizationNote      String?  @db.Text // e.g., "optimized for high visibility"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([platform])
  @@index([createdAt])
  @@map("blueprints")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // "user.login", "post.analyzed", "company.created"
  entityType String?  // "Post", "Company", "User"
  entityId   String?
  metadata   Json?    // Additional data about the action
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}