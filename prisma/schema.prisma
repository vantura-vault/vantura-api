generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String?   // Hashed password (bcrypt) - nullable for migration
  companyId    String?   // User's company (optional - user might not have company yet)
  role         String    @default("member") // "owner", "admin", "member"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  authTokens AuthToken[]
  company    Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([companyId])
  @@map("users")
}

model AuthToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("auth_tokens")
}

// ============================================
// COMPANY
// ============================================

model Company {
  id                String   @id @default(cuid())
  name              String
  industry          String?
  description       String?  @db.Text
  values            String?  @db.Text // JSON array of core values
  brandVoice        String?  @db.Text
  targetAudience    String?  @db.Text
  strategicGoals    String?  @db.Text // JSON array of goals (deprecated)
  personalNotes     String?  @db.Text // Free-form personal notes
  contentPriorities String?  @db.Text // JSON object: content style preferences (data-driven, storytelling, educational, etc.)
  profilePictureUrl String?  // Company profile picture/logo URL
  linkedInUrl       String?  @unique // LinkedIn profile or company page URL (unique identifier)
  linkedInType      String?  // 'profile' or 'company'
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  users             User[]
  platforms         CompanyPlatform[]
  posts             Post[]
  relationships     CompanyRelationship[] @relation("CompanyA")
  relatedTo         CompanyRelationship[] @relation("CompanyB")
  platformSnapshots PlatformSnapshot[]
  blueprints        Blueprint[]
  initiatedScrapeJobs ScrapeJob[] @relation("InitiatedJobs")
  targetedScrapeJobs  ScrapeJob[] @relation("TargetedJobs")
  files             CompanyFile[]
  drafts            PostDraft[]

  @@map("companies")
}

model CompanyRelationship {
  id               String    @id @default(cuid())
  companyAId       String
  companyBId       String
  relationshipType String    // "competitor", "partner", etc.
  createdAt        DateTime  @default(now())
  lastScrapedAt    DateTime? // Track when competitor was last scraped (for cooldown)

  // Relations
  companyA Company @relation("CompanyA", fields: [companyAId], references: [id], onDelete: Cascade)
  companyB Company @relation("CompanyB", fields: [companyBId], references: [id], onDelete: Cascade)

  @@unique([companyAId, companyBId])
  @@index([companyAId])
  @@index([companyBId])
  @@map("company_relationships")
}

model CompanyFile {
  id           String   @id @default(cuid())
  companyId    String
  filename     String   // Unique filename in S3
  originalName String   // Original uploaded filename
  mimeType     String   // MIME type (e.g., application/pdf, image/png)
  size         Int      // File size in bytes
  s3Key        String   // S3 object key
  s3Url        String   // Public URL to the file
  contentHash  String?  // SHA-256 hash for duplicate detection
  uploadedAt   DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, contentHash]) // Prevent duplicates per company
  @@index([companyId])
  @@map("company_files")
}

// ============================================
// PLATFORMS
// ============================================

model Platform {
  id   String @id @default(cuid())
  name String @unique

  // Relations
  companyPlatforms CompanyPlatform[]
  posts            Post[]

  @@map("platforms")
}

model CompanyPlatform {
  id         String   @id @default(cuid())
  companyId  String
  platformId String
  profileUrl String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform  Platform           @relation(fields: [platformId], references: [id], onDelete: Cascade)
  snapshots PlatformSnapshot[]

  @@unique([companyId, platformId])
  @@index([companyId])
  @@index([platformId])
  @@map("company_platforms")
}

model PlatformSnapshot {
  id            String   @id @default(cuid())
  companyId     String
  platformId    String
  capturedAt    DateTime @default(now())
  followerCount Int
  postCount     Int

  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyPlatform CompanyPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([companyId, platformId, capturedAt])
  @@map("platform_snapshots")
}

// ============================================
// POSTS & METRICS
// ============================================

model Post {
  id             String   @id @default(cuid())
  companyId      String
  platformId     String
  platformPostId String   // External ID from the platform
  captionText    String?  @db.Text
  postUrl        String
  mediaType      String   // "image", "video", "carousel", "reel"
  postedAt       DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform         Platform       @relation(fields: [platformId], references: [id], onDelete: Cascade)
  metricsSnapshots PostSnapshot[]
  analysis         PostAnalysis?

  @@unique([companyId, platformId, platformPostId])
  @@index([companyId])
  @@index([platformId])
  @@index([postedAt])
  @@map("posts")
}

model PostSnapshot {
  id           String   @id @default(cuid())
  postId       String
  capturedAt   DateTime @default(now())
  likeCount    Int      @default(0)
  commentCount Int      @default(0)

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, capturedAt])
  @@map("post_snapshots")
}

// ============================================
// AI ANALYSIS
// ============================================

model PostAnalysis {
  id                     String   @id @default(cuid())
  postId                 String   @unique
  modelVersion           String   // Track which AI model version was used
  runAt                  DateTime @default(now())

  // Performance metrics
  impressions            Int      @default(0) // Total views/impressions
  engagement             Int      @default(0) // Total engagement (likes + comments + shares)

  // Analysis results
  topics                 String[] // Array of identified topics
  summary                String   @db.Text
  entities               String[] // Brands, people, places mentioned
  captionSentiment       Float    // -1.0 to 1.0
  avgCommentSentiment    Float?
  commentSentimentStd    Float?   // Standard deviation
  medianCommentSentiment Float?
  positiveDescription    String   @db.Text
  imageDescription       String   @db.Text
  negativeDescription    String   @db.Text

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([runAt])
  @@map("post_analyses")
}

// ============================================
// BLUEPRINTS - AI-Generated Post Strategies
// ============================================

model Blueprint {
  id        String   @id @default(cuid())
  companyId String
  title     String   // e.g., "Engaging LinkedIn Thought Leadership Post"
  platform  String   // "LinkedIn", "Twitter", etc.
  actionType String? // "post", "comment", "repost", "story", "video"

  // Generation inputs
  objective           String   // User's objective (e.g., "thought leadership")
  topicTags           String[] // Topics used for generation
  contentAngle        String?  // Content focus: "data-driven", "storytelling", "educational", "how-to"
  useDataChamber      Boolean  @default(true)
  useYourTopPosts     Boolean  @default(true)
  useCompetitorPosts  Boolean  @default(true)

  // AI Reasoning
  reasoning           String?  @db.Text // LLM's explanation for why this blueprint works

  // Visual Description
  visualDescription String   @db.Text

  // References
  references        String?  @db.Text // JSON: inspired by top 3 industry leaders with avatars

  // Post Copy
  hook              String   @db.Text
  context           String   @db.Text

  // Hashtags & Mentions
  hashtags          Json     // Array of {tag: string, engagement: string}
  mentions          Json?    // Array of {handle: string, engagement: string}

  // Posting Intelligence
  bestTimeToPost        String?  // e.g., "Tuesdays, 10 AM PST"
  recommendedFormat     String?  // e.g., "Carousel Post (Image + Text)"
  postingInsight        String?  @db.Text

  // Data & Insights
  dataSources           String[] // e.g., ["Competitor Vault", "Talkwater API", "Brandwat"]
  timeWindow            String?  // e.g., "Last 30 Days"
  confidence            Float?   // e.g., 0.90 for 90%
  yourPerformanceScore  Float?   // Performance bar value (0-100)
  competitorScore       Float?   // Competitor performance bar value (0-100)

  // Performance Forecast
  vanturaScore          Float?   // e.g., 85 (out of 100)
  estimatedReachMin     Int?     // e.g., 8500
  estimatedReachMax     Int?     // e.g., 10000
  estimatedEngagementMin Float?  // e.g., 1.2 (percentage)
  estimatedEngagementMax Float?  // e.g., 1.8 (percentage)
  optimizationNote      String?  @db.Text // e.g., "optimized for high visibility"

  // Content Guidance (Process-based blueprint)
  contentFramework      Json?    // {structure: string, toneGuidance: string[]}
  whatToInclude         Json?    // Array of {label: string, guidance: string, competitorInsight?: string}
  whatNotToDo           Json?    // Array of {antiPattern: string, reason: string}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  drafts  PostDraft[]

  @@index([companyId])
  @@index([platform])
  @@index([actionType])
  @@index([createdAt])
  @@map("blueprints")
}

// ============================================
// POST DRAFTS - User-Created Posts in Progress
// ============================================

model PostDraft {
  id            String   @id @default(cuid())
  companyId     String
  blueprintId   String

  // Content
  platform      String   // "LinkedIn", "Twitter", etc.
  imageUrl      String?  // Uploaded image URL (null for text-only)
  caption       String?  @db.Text // User's written caption
  selectedHashtags String[] // Hashtags user selected to include

  // Wizard State
  currentStep   Int      @default(1) // 1=Overview, 2=Visual, 3=Caption, 4=Upload
  status        String   @default("in_progress") // "in_progress" | "ready_to_publish"

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  blueprint Blueprint @relation(fields: [blueprintId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([blueprintId])
  @@index([status])
  @@map("post_drafts")
}

// ============================================
// SCRAPE JOBS (Async Post Scraping)
// ============================================

model ScrapeJob {
  id            String    @id @default(cuid())
  companyId     String    // User's company that initiated the scrape
  targetId      String    // Competitor company being scraped
  targetUrl     String    // LinkedIn URL being scraped
  platform      String    // "LinkedIn", "Twitter", etc.
  scrapeType    String    // "company" | "profile" | "posts"

  // Job status
  status        String    @default("pending") // pending, in_progress, completed, failed
  progress      Int       @default(0)         // 0-100
  errorMessage  String?   @db.Text

  // Results
  postsScraped  Int       @default(0)

  // Timestamps
  createdAt     DateTime  @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  // Relations
  initiatingCompany Company @relation("InitiatedJobs", fields: [companyId], references: [id], onDelete: Cascade)
  targetCompany     Company @relation("TargetedJobs", fields: [targetId], references: [id], onDelete: Cascade)
  pendingSnapshots  PendingSnapshot[]

  @@index([companyId])
  @@index([targetId])
  @@index([status])
  @@map("scrape_jobs")
}

// ============================================
// PENDING SNAPSHOTS (BrightData async polling)
// ============================================

model PendingSnapshot {
  id            String   @id @default(cuid())
  snapshotId    String   @unique // BrightData snapshot ID
  scrapeJobId   String   // Reference to ScrapeJob
  companyId     String   // Company that initiated (for WebSocket notifications)
  targetId      String   // Target company being scraped
  targetUrl     String   // LinkedIn URL
  platform      String   @default("LinkedIn")

  // Retry tracking
  attempts      Int      @default(0)
  maxAttempts   Int      @default(60) // ~30 min at 30s intervals
  lastCheckedAt DateTime?

  // Timestamps
  createdAt     DateTime @default(now())

  // Relations
  scrapeJob     ScrapeJob @relation(fields: [scrapeJobId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@map("pending_snapshots")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // "user.login", "post.analyzed", "company.created"
  entityType String?  // "Post", "Company", "User"
  entityId   String?
  metadata   Json?    // Additional data about the action
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}